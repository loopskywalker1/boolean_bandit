# elasticsearch.yaml
apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  name: elasticsearch
  namespace: monitoring
spec:
  version: 8.17.0
  nodeSets:
    - name: master-nodes
      count: 1
      config:
        node.roles: ["master"]
        node.store.allow_mmap: false
        xpack.security.enabled: true
        xpack.security.transport.ssl.enabled: true
        xpack.security.http.ssl.enabled: true
        xpack.security.authc.token.enabled: true
        ingest.geoip.downloader.enabled: false
        xpack.security.autoconfiguration.enabled: true
      podTemplate:
        spec:
          initContainers:
          - name: sysctl
            securityContext:
              privileged: true
            command: ['sh', '-c', 'sysctl -w vm.max_map_count=262144']
          containers:
          - name: elasticsearch
            resources:
              requests:
                memory: 2Gi
                cpu: "500m"
              limits:
                memory: 4Gi
                cpu: "1000m"
            env:
            - name: ES_JAVA_OPTS
              value: "-Xms1g -Xmx1g"
      volumeClaimTemplates:
        - metadata:
            name: elasticsearch-data
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 50Gi
            storageClassName: longhorn
    - name: data-nodes
      count: 2
      config:
        node.roles: ["data", "ingest"]
        node.store.allow_mmap: false
        xpack.security.enabled: true
        xpack.security.transport.ssl.enabled: true
        xpack.security.http.ssl.enabled: true
        xpack.security.authc.token.enabled: true
        ingest.geoip.downloader.enabled: false
        xpack.security.autoconfiguration.enabled: true
      podTemplate:
        spec:
          initContainers:
          - name: sysctl
            securityContext:
              privileged: true
            command: ['sh', '-c', 'sysctl -w vm.max_map_count=262144']
          containers:
          - name: elasticsearch
            resources:
              requests:
                memory: 4Gi
                cpu: "1000m"
              limits:
                memory: 8Gi
                cpu: "2000m"
            env:
            - name: ES_JAVA_OPTS
              value: "-Xms2g -Xmx2g"
      volumeClaimTemplates:
        - metadata:
            name: elasticsearch-data
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 100Gi
            storageClassName: longhorn

---
# kibana.yaml
apiVersion: kibana.k8s.elastic.co/v1
kind: Kibana
metadata:
  name: kibana
  namespace: monitoring
spec:
  version: 8.17.0
  count: 1
  elasticsearchRef:
    name: elasticsearch
  config:
    elasticsearch.ssl.verificationMode: "none"
    xpack.security.authc.providers:
      basic.basic1:
        order: 0
  podTemplate:
    spec:
      securityContext:
        fsGroup: 1000
      containers:
      - name: kibana
        env:
        - name: NODE_OPTIONS
          value: "--max-old-space-size=1024"
        - name: ELASTICSEARCH_SSL_VERIFICATIONMODE
          value: "none"
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
  http:
    tls:
      selfSignedCertificate:
        disabled: true

---
# ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: elk-ingress
  namespace: monitoring
  annotations:
    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
    nginx.ingress.kubernetes.io/ssl-passthrough: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - kibana.acidev.mycompany.com
    secretName: kibana-tls
  rules:
  - host: kibana.acidev.mycompany.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: kibana-kb-http
            port:
              number: 5601


-----------

# 1. Remove existing deployments
kubectl delete kibana -n monitoring kibana
kubectl delete elasticsearch -n monitoring elasticsearch
kubectl delete ingress -n monitoring --all
kubectl delete service -n monitoring --all

# 2. Clean up secrets and config maps
kubectl delete secret -n monitoring --all
kubectl delete configmap -n monitoring --all

# 3. Clean up namespaces
kubectl delete namespace monitoring
kubectl delete namespace elastic-system

# 4. Remove Helm ECK operator
helm uninstall elastic-operator -n elastic-system


kubectl create namespace elastic-system
kubectl create namespace monitoring
---------------


# Add Elastic repo if not already added
helm repo add elastic https://helm.elastic.co
helm repo update

# Install ECK operator
helm install elastic-operator elastic/eck-operator -n elastic-system --version 2.11.1

# Verify operator is running
kubectl get pods -n elastic-system -w

------------------

kubectl apply -f elasticsearch.yaml

# Watch Elasticsearch pods
kubectl get pods -n monitoring -w

# Wait until all pods are Running and Ready (1/1 for master, 1/1 for data nodes)

-----------------

# Get elastic user password
kubectl get secret elasticsearch-es-elastic-user -n monitoring -o=jsonpath='{.data.elastic}' | base64 --decode; echo

# Verify cluster health (replace PASSWORD with the one from above)
kubectl exec -it elasticsearch-es-master-nodes-0 -n monitoring -- curl -k -u "elastic:PASSWORD" https://localhost:9200/_cluster/health

# Check if security index exists
kubectl exec -it elasticsearch-es-master-nodes-0 -n monitoring -- curl -k -u "elastic:PASSWORD" https://localhost:9200/_cat/indices

---------
kubectl apply -f kibana.yaml

# Watch Kibana pod
kubectl get pods -n monitoring -w

----------

kubectl apply -f ingress.yaml

-------
# Check all pods
kubectl get pods -n monitoring

# Check services
kubectl get svc -n monitoring

# Check ingress
kubectl get ingress -n monitoring
