# elasticsearch.yaml
apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  name: elasticsearch
  namespace: monitoring
spec:
  version: 8.17.0
  nodeSets:
    - name: master-nodes
      count: 1
      config:
        node.roles: ["master"]
        node.store.allow_mmap: false
        xpack.security.enabled: true
        xpack.security.transport.ssl.enabled: true
        xpack.security.http.ssl.enabled: true
        xpack.security.authc.token.enabled: true
        ingest.geoip.downloader.enabled: false
        xpack.security.autoconfiguration.enabled: true
      podTemplate:
        spec:
          initContainers:
          - name: sysctl
            securityContext:
              privileged: true
            command: ['sh', '-c', 'sysctl -w vm.max_map_count=262144']
          containers:
          - name: elasticsearch
            resources:
              requests:
                memory: 2Gi
                cpu: "500m"
              limits:
                memory: 4Gi
                cpu: "1000m"
            env:
            - name: ES_JAVA_OPTS
              value: "-Xms1g -Xmx1g"
      volumeClaimTemplates:
        - metadata:
            name: elasticsearch-data
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 50Gi
            storageClassName: longhorn
    - name: data-nodes
      count: 2
      config:
        node.roles: ["data", "ingest"]
        node.store.allow_mmap: false
        xpack.security.enabled: true
        xpack.security.transport.ssl.enabled: true
        xpack.security.http.ssl.enabled: true
        xpack.security.authc.token.enabled: true
        ingest.geoip.downloader.enabled: false
        xpack.security.autoconfiguration.enabled: true
      podTemplate:
        spec:
          initContainers:
          - name: sysctl
            securityContext:
              privileged: true
            command: ['sh', '-c', 'sysctl -w vm.max_map_count=262144']
          containers:
          - name: elasticsearch
            resources:
              requests:
                memory: 4Gi
                cpu: "1000m"
              limits:
                memory: 8Gi
                cpu: "2000m"
            env:
            - name: ES_JAVA_OPTS
              value: "-Xms2g -Xmx2g"
      volumeClaimTemplates:
        - metadata:
            name: elasticsearch-data
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 100Gi
            storageClassName: longhorn

---
# kibana.yaml
apiVersion: kibana.k8s.elastic.co/v1
kind: Kibana
metadata:
  name: kibana
  namespace: monitoring
spec:
  version: 8.17.0
  count: 1
  elasticsearchRef:
    name: elasticsearch
  config:
    elasticsearch.ssl.verificationMode: "none"
    xpack.security.authc.providers:
      basic.basic1:
        order: 0
  podTemplate:
    spec:
      securityContext:
        fsGroup: 1000
      containers:
      - name: kibana
        env:
        - name: NODE_OPTIONS
          value: "--max-old-space-size=1024"
        - name: ELASTICSEARCH_SSL_VERIFICATIONMODE
          value: "none"
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
  http:
    tls:
      selfSignedCertificate:
        disabled: true

---
# ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: elk-ingress
  namespace: monitoring
  annotations:
    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
    nginx.ingress.kubernetes.io/ssl-passthrough: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - kibana.acidev.mycompany.com
    secretName: kibana-tls
  rules:
  - host: kibana.acidev.mycompany.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: kibana-kb-http
            port:
              number: 5601
